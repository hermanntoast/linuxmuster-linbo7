#!/bin/sh
#
# linbo_auth
# thomas@linuxmuster.net
# 20230125
#

usage(){
  echo
  echo "Authenticates linbo user."
  echo
  echo "Usage:"
  echo "  linbo_auth <password> | [help]"
  echo
  echo "For compatibility reasons legacy options are also accepted but not used:"
  echo "  linbo_auth <server> <user> <password>"
  echo
  exit 0
}

# print help
[ -z "$1" -o "$1" = "help" ] && usage

# last parameter is password in any case
export RSYNC_PASSWORD="$(echo "$@" | awk '{print $NF}')"

if [ -e /etc/linbo_passwd ]; then
  echo "Using local authentication ..."
  given_pwhash="$(echo -n "$RSYNC_PASSWORD" | sha256sum | awk '{ print $1 }')"
  linbo_pwhash="$(cat /etc/linbo_passwd)"
  if [ "$given_pwhash" = "$linbo_pwhash" ]; then
    msg="Password matches."; RC=0
    # temporary workaround for password
    echo -n "$RSYNC_PASSWORD" > /tmp/linbo.passwd
  else
    msg="Password does not match!"; RC=1
  fi
else
  msg="No password file available!"; RC=2
fi

echo "$msg"

exit "$RC"
