#!/bin/sh
#
# linbo_warmstart
# thomas@linuxmuster.net
# 20231125
#

# get environment
source /usr/share/linbo/shell_functions

# no warmstart in this cases
if ! warmstart; then
  echo "Linbo warmstart is switched off."
  exit 0
fi

KEXEC="/sbin/kexec"
KERNEL="/cache/linbo64"
INITRD="/cache/linbofs64"

linbo_mountcache || exit 1

if [ ! -s "$KERNEL" -o ! -s "$INITRD" ]; then
  echo "Linbokernel not found!"
  exit 1
fi

if warmstart; then

  echo "Initiating linbo warmstart ..."

  # load linbo kernel
  if ! $KEXEC --type="bzImage64" --reuse-cmdline --initrd="$INITRD" --load "$KERNEL"; then
    echo "Failed to load kernel!"
    exit 1
  fi
  # execute linbo kernel
  if ! $KEXEC -e; then
    echo "Failed to execute kernel!"
    exit 1
  fi

else

  linbo_reboot

fi