#!/bin/bash
#
# download and build kernel
#
# thomas@linuxmuster.net
# 20231116
#

# read build environment
for i in build/conf.d/*; do source "$i" || exit 1; done

# download verified kernel archive
if [ ! -s "$KARCHIVE" ]; then
  echo "Downloading kernel $KVERS ..."
  "$KGET" "$KVERS" || exit 1
fi

# unpack
if [ -d "$KSRCDIR" ]; then
  echo "$KSRCDIR exists, skipping archive extraction."
else
  tar xf "$KARCHIVE" -C "$SRC" || exit 1
fi

# compile
if [ -s "$KIMAGE" ]; then
  echo "Kernelimage exists, skipping compilation."
else
  # copy kernel config file
  cp "$KCONFIG" "$KSRCDIR/.config" || exit 1
  # configure kernel
  cd "$KSRCDIR"
  make olddefconfig || exit 1
  # provide initramfs config
  ln -snf "$INITRAMFS_KERNEL" "$SRC/initramfs_kernel.conf"
  # make
  make $J_OPT bzImage modules || exit 1
  # remove initramfs config link
  rm -f "$SRC/initramfs_kernel.conf"
  # remove external modules source dir
  rm -rf "$KEXTMODDIR"
fi

echo "Copying LINBO stable kernel ..."
mkdir -p "$KSTBDIR"
cp "$KIMAGE" "$KSTBDIR/linbo64" || exit 1
echo "$KVERS" > "$KSTBDIR/version" || exit 1

# install modules in tmp dir
rm -rf "$KMODTMP"
mkdir -p "$KMODTMP"
cd "$KSRCDIR"
make INSTALL_MOD_PATH="$KMODTMP" modules_install || exit 1
